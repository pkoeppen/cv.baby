service: cv-server

provider:
  name: aws
  runtime: nodejs10.x
  region: us-east-1
  stage: ${opt:stage, "dev"}
  environment: ${file(./env.yml):${opt:stage, "dev"}}
  timeout: 30
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:BatchGetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:*"
    - Effect: Allow
      Action:
        - s3:*
      Resource: "arn:aws:s3:::${self:provider.environment.CVBABY_BUCKET_PRE}/*"
    - Effect: Allow
      Action:
        - s3:*
      Resource: "arn:aws:s3:::${self:provider.environment.CVBABY_BUCKET_POST}/*"
    - Effect: Allow
      Action:
        - "ses:SendEmail"
      Resource: "*"

plugins:
  - serverless-offline
  - serverless-webpack
  - serverless-domain-manager
  - serverless-s3-local

custom:
  serverless-offline:
    port: 3001
  s3:
    host: 0.0.0.0
    port: 8000
    directory: /tmp
    cors: ./cors.xml
  webpack:
    webpackConfig: ./webpack.config.js
  customDomain:
    domainName: ${opt:domain, "api.cv.baby"}
    basePath: ''
    stage: ${opt:stage, "dev"}
    createRoute53Record: true
    # endpointType: 'regional'


functions:

  ### Authentication

  auth:
    handler: auth/handler.authorizer

  ### GQL Public

  public:
    handler: handler.public
    events:
      - http:
          path: /api/public
          method: post
          cors: true

  ### GQL Private

  private:
    handler: handler.private
    events:
      - http:
          path: /api/private
          method: post
          authorizer: auth
          cors: true

  ### Stripe Webhook

  stripe:
    handler: handler.stripe
    events:
      - http:
          path: /api/stripe
          method: post
          cors: true

resources:
  Resources:

    ### S3 Bucket (Preprocess)

    BucketPreprocess:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.CVBABY_BUCKET_PRE}
        CorsConfiguration:
          CorsRules:
            -
              AllowedOrigins:
                - "*"
              AllowedHeaders:
                - "*"
              AllowedMethods:
                - PUT
              MaxAge: 3000

    ### S3 Bucket (Postprocess)

    BucketPostprocess:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.CVBABY_BUCKET_POST}
        CorsConfiguration:
          CorsRules:
            -
              AllowedOrigins:
                - "*"
              AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
              MaxAge: 3000

    ### DynamoDB Users Table

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: "${self:provider.environment.CVBABY_TABLE_USERS}"

    ### DynamoDB Slugs Table

    SlugsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
        - AttributeName: slug
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        KeySchema:
        - AttributeName: slug
          KeyType: HASH
        GlobalSecondaryIndexes:
          # GSI to query a slug by user_id.
        - IndexName: "${self:provider.environment.CVBABY_TABLE_SLUGS}-GSI"
          KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          Projection:
            ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        TableName: "${self:provider.environment.CVBABY_TABLE_SLUGS}"

    ### DynamoDB Invites Table

    InvitationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: invite_id
          AttributeType: S
        KeySchema:
          # Default - Query invites by user_id.
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: invite_id
          KeyType: RANGE
        GlobalSecondaryIndexes:
          # GSI to query invitations by invite_id.
        - IndexName: "${self:provider.environment.CVBABY_TABLE_INVITES}-GSI"
          KeySchema:
          - AttributeName: invite_id
            KeyType: HASH
          Projection:
            ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        TableName: "${self:provider.environment.CVBABY_TABLE_INVITES}"

    # This response is needed for custom authorizer failures CORS support.
    # https://docs.aws.amazon.com/apigateway/latest/developerguide/customize-gateway-responses.html
    GatewayResponse:
      Type: "AWS::ApiGateway::GatewayResponse"
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: EXPIRED_TOKEN
        RestApiId:
          Ref: "ApiGatewayRestApi"
        StatusCode: "401"
    AuthFailureGatewayResponse:
      Type: "AWS::ApiGateway::GatewayResponse"
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: UNAUTHORIZED
        RestApiId:
          Ref: "ApiGatewayRestApi"
        StatusCode: "401"
